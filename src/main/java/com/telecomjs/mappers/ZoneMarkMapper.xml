<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.telecomjs.mappers.ZoneMarkMapper">
  <resultMap id="BaseResultMap" type="com.telecomjs.beans.ZoneMark">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="MARK_ID" jdbcType="DECIMAL" property="markId" />
    <result column="ZONE_ID" jdbcType="DECIMAL" property="zoneId" />
    <result column="ITEM_ID" jdbcType="DECIMAL" property="itemId" />
    <result column="BILLING_CYCLE" jdbcType="DECIMAL" property="billingCycle" />
    <result column="VAL" jdbcType="DECIMAL" property="val" />
    <result column="LAST_VAL" jdbcType="DECIMAL" property="lastVal" />
    <result column="MARK" jdbcType="DECIMAL" property="mark" />
    <result column="WEIGHT_MARK" jdbcType="DECIMAL" property="weightMark" />
  </resultMap>
  <resultMap id="BaseResultMapWithItem" type="com.telecomjs.beans.ZoneMarkWithItem" extends="BaseResultMap" >
    <association property="item" javaType="com.telecomjs.beans.ZoneMarkItem" >
      <id column="MI_ITEM_ID" jdbcType="DECIMAL" property="itemId" />
      <result column="MI_RULE_ID" jdbcType="DECIMAL" property="ruleId" />
      <result column="MI_NAME" jdbcType="VARCHAR" property="name" />
      <result column="MI_DESCRIPTION" jdbcType="VARCHAR" property="description" />
      <result column="MI_CODE" jdbcType="VARCHAR" property="code" />
      <result column="MI_WEIGHT" jdbcType="DECIMAL" property="weight" />
    </association>
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    MARK_ID, ZONE_ID, ITEM_ID, BILLING_CYCLE, VAL, LAST_VAL, MARK, WEIGHT_MARK
  </sql>
  <sql id="Base_Column_List_Item">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    MARK_ID, ZONE_ID, m.ITEM_ID as ITEM_ID, BILLING_CYCLE, VAL, LAST_VAL, MARK, WEIGHT_MARK, MI.ITEM_ID as MI_ITEM_ID,
    MI.RULE_ID as MI_RULE_ID , MI.NAME as MI_NAME, MI.DESCRIPTION as MI_DESCRIPTION, MI.CODE as MI_CODE,
    MI.WEIGHT as MI_WEIGHT
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from ZONE_MARK
    where MARK_ID = #{markId,jdbcType=DECIMAL}
  </select>
  <select id="findMarkWithCode" resultMap="BaseResultMapWithItem">
    SELECT <include refid="Base_Column_List_Item" />
    FROM zone_mark m
    join zone_mark_item mi on m.item_id=mi.item_id and mi.code=#{code}
    where  zone_id = #{zoneId}
    and   billing_Cycle = #{billingCycle}

  </select>
  <select id="findMDCN" resultMap="BaseResultMap">
    select b.area_id_tm as zone_id,stat_mon as billing_cycle,0.0 as last_val,nvl(天翼积分不含副卡,0)+nvl(宽带和ITV积分2,0)+nvl(流量包积分,0)+nvl(活卡积分,0) as val
    from mon.gz_qdjf_jf_all a,pub.app_ydbp_area_channel b
    where STAT_MON=#{billingCycle}
    and   a.channel_id=b.channel_id
  </select>
  <select id="findSTLTS" resultMap="BaseResultMap">
    select m4.area_id_tm as zoneid,m3.lastval as last_val, m4.val   from (
    select area_id_tm,round(sum(nvl(bip_rec_cnt,0))/sum(nvl(room_cnt,0)),4) val
    from pub.app_ydbp_area_grid_rslt_all
    where stat_day= to_char( to_date(#{billingCycle},'yyyymm')-1,'yyyymmdd') --3月宽带渗透率改为 20170331，依此类推
    group by area_id_tm )m4
    left  join (
    select area_id_tm,round(sum(nvl(bip_rec_cnt,0))/sum(nvl(room_cnt,0)),4) lastval
    from pub.app_ydbp_area_grid_rslt_all
    where stat_day=to_char(last_day( to_date(#{billingCycle},'yyyymm')),'yyyymmdd') --3月宽带渗透率改为 20170331，依此类推
    group by area_id_tm ) m3 on m4.area_id_tm=m3.area_id_tm
  </select>
  <select id="findZWYX" resultMap="BaseResultMap">
    select area_id_tm as zoneid,count(distinct assist_num) as last_val,sum(nvl(cnt_bip,0)+nvl(cnt_cdma,0)+nvl(cnt_itv,0)+nvl(cnt_zhzw,0)) as val
    from pub.app_ydbp_area_STAFF_rslt_all
    where stat_day=to_char(last_day( to_date(#{billingCycle},'yyyymm')),'yyyymmdd') --3月，每月取月底最后一天
    group by area_id_tm
  </select>
  <select id="getPrimaryKey" resultType="java.lang.Long">
    SELECT seq_zone_mark.nextval FROM dual
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from ZONE_MARK
    where MARK_ID = #{markId,jdbcType=DECIMAL}
  </delete>
  <delete id="deleteByCycle">
    DELETE from ZONE_MARK
    where  billing_cycle = #{billingCycle}
  </delete>
  <insert id="insert" parameterType="com.telecomjs.beans.ZoneMark">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into ZONE_MARK (MARK_ID, ZONE_ID, ITEM_ID, 
      BILLING_CYCLE, VAL, LAST_VAL, 
      MARK, WEIGHT_MARK)
    values (#{markId,jdbcType=DECIMAL}, #{zoneId,jdbcType=DECIMAL}, #{itemId,jdbcType=DECIMAL}, 
      #{billingCycle,jdbcType=DECIMAL}, #{val,jdbcType=DECIMAL}, #{lastVal,jdbcType=DECIMAL}, 
      #{mark,jdbcType=DECIMAL}, #{weightMark,jdbcType=DECIMAL})
  </insert>
  <insert id="insertSelective" parameterType="com.telecomjs.beans.ZoneMark">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into ZONE_MARK
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="markId != null">
        MARK_ID,
      </if>
      <if test="zoneId != null">
        ZONE_ID,
      </if>
      <if test="itemId != null">
        ITEM_ID,
      </if>
      <if test="billingCycle != null">
        BILLING_CYCLE,
      </if>
      <if test="val != null">
        VAL,
      </if>
      <if test="lastVal != null">
        LAST_VAL,
      </if>
      <if test="mark != null">
        MARK,
      </if>
      <if test="weightMark != null">
        WEIGHT_MARK,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="markId != null">
        #{markId,jdbcType=DECIMAL},
      </if>
      <if test="zoneId != null">
        #{zoneId,jdbcType=DECIMAL},
      </if>
      <if test="itemId != null">
        #{itemId,jdbcType=DECIMAL},
      </if>
      <if test="billingCycle != null">
        #{billingCycle,jdbcType=DECIMAL},
      </if>
      <if test="val != null">
        #{val,jdbcType=DECIMAL},
      </if>
      <if test="lastVal != null">
        #{lastVal,jdbcType=DECIMAL},
      </if>
      <if test="mark != null">
        #{mark,jdbcType=DECIMAL},
      </if>
      <if test="weightMark != null">
        #{weightMark,jdbcType=DECIMAL},
      </if>
    </trim>
  </insert>
  <insert id="insertManual">
    insert into zone_mark ( mark_id,zone_id,item_id,billing_cycle,val,last_val,mark,weight_mark)
    select mark_id,zone_id,item_id,billing_cycle,weight_mark as val,weight_mark as last_val,weight_mark,weight_mark  from zone_mark_manual
    where  billing_cycle = #{billingCycle}
  </insert>
  <insert id="insertBatch" parameterType="java.util.List"  >
    INSERT into zone_mark ( mark_id,zone_id,item_id,billing_cycle,val,last_val,mark,weight_mark)
    SELECT
    SEQ_ZONE_MARK.NEXTVAL , T.* from
    (
    <foreach close="" collection="markList" item="item" index="index" open="" separator=" union all ">
      SELECT
      #{item.zoneId,jdbcType=DECIMAL},
      #{item.itemId,jdbcType=DECIMAL},
      #{item.billingCycle,jdbcType=DECIMAL},
      #{item.val,jdbcType=DECIMAL},
      #{item.lastVal,jdbcType=DECIMAL},
      #{item.mark,jdbcType=DECIMAL},
      #{item.weightMark,jdbcType=DECIMAL}
      from dual
    </foreach>
    ) T
  </insert>
  <insert id="insertAssessment">
    INSERT INTO zone_mark_assessment
    select a.mark_id,a.zone_id,a.channel_type,a.delegate_type,seq_assessment_id.nextval,a.billing_cycle,b.mark,a.criterion , round(b.mark/100*a.criterion,2)    reward,round(b.mark/100*a.criterion,2)*2 reward2,sysdate
    from zone_mark_base a,(select zone_id,sum(weight_mark) mark from zone_mark where billing_cycle=#{billingCycle} group by zone_id) b
    where  a.zone_id = b.zone_id
    and    a.billing_cycle = #{billingCycle}
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.telecomjs.beans.ZoneMark">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update ZONE_MARK
    <set>
      <if test="zoneId != null">
        ZONE_ID = #{zoneId,jdbcType=DECIMAL},
      </if>
      <if test="itemId != null">
        ITEM_ID = #{itemId,jdbcType=DECIMAL},
      </if>
      <if test="billingCycle != null">
        BILLING_CYCLE = #{billingCycle,jdbcType=DECIMAL},
      </if>
      <if test="val != null">
        VAL = #{val,jdbcType=DECIMAL},
      </if>
      <if test="lastVal != null">
        LAST_VAL = #{lastVal,jdbcType=DECIMAL},
      </if>
      <if test="mark != null">
        MARK = #{mark,jdbcType=DECIMAL},
      </if>
      <if test="weightMark != null">
        WEIGHT_MARK = #{weightMark,jdbcType=DECIMAL},
      </if>
    </set>
    where MARK_ID = #{markId,jdbcType=DECIMAL}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.telecomjs.beans.ZoneMark">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update ZONE_MARK
    set ZONE_ID = #{zoneId,jdbcType=DECIMAL},
      ITEM_ID = #{itemId,jdbcType=DECIMAL},
      BILLING_CYCLE = #{billingCycle,jdbcType=DECIMAL},
      VAL = #{val,jdbcType=DECIMAL},
      LAST_VAL = #{lastVal,jdbcType=DECIMAL},
      MARK = #{mark,jdbcType=DECIMAL},
      WEIGHT_MARK = #{weightMark,jdbcType=DECIMAL}
    where MARK_ID = #{markId,jdbcType=DECIMAL}
  </update>
</mapper>